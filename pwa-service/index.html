<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="theme-color" content="#f0f0f0">
        <meta name="description" content="j e l l i c u l e - A modern web component library">
        <title>j e l l i c u l e ! ! !</title>
        <link rel="stylesheet" href="styles/reset.css">
        <link rel="stylesheet" href="styles/jellicule.css">
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="icons/favicon.ico">
        <link rel="apple-touch-icon" href="icons/icon-192x192.png">
        <!-- WebSocket hot-reload and build status script -->
        <script>
            // Check if we're running in offline mode
            let isOfflineMode = false;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 3;

            // Function to update the build status display
            const updateBuildStatus = (status, isOffline = false) => {
                const buildStatusElement = document.getElementById('build-status');
                if (buildStatusElement) {
                    if (isOffline) {
                        buildStatusElement.textContent = 'Offline Mode - Local Version';
                        buildStatusElement.className = 'build-status offline';
                    } else {
                        buildStatusElement.textContent = `Build: ${status.status} | Last build: ${status.time} | Version: ${status.version}`;
                        buildStatusElement.className = `build-status ${status.status}`;
                    }
                }

                if (!isOffline) {
                    localStorage.setItem('jelliculeVersion', status.version);
                    localStorage.setItem('jelliculeLastStatus', JSON.stringify(status));
                }
            };

            // Connect to WebSocket server for real-time updates
            const connectWebSocket = () => {
                // If we're in offline mode and not explicitly trying to reconnect, don't attempt connection
                if (isOfflineMode && reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                    console.log('Running in offline mode, not attempting WebSocket connection');
                    return;
                }

                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.hostname;
                    const ws = new WebSocket(`${protocol}//${host}:8080`);

                    // Set a connection timeout
                    const connectionTimeout = setTimeout(() => {
                        console.log('WebSocket connection timeout');
                        ws.close();
                    }, 5000);

                    ws.onopen = () => {
                        console.log('WebSocket connected');
                        clearTimeout(connectionTimeout);
                        reconnectAttempts = 0;
                        isOfflineMode = false;
                    };

                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);

                            if (message.type === 'build-status') {
                                const status = message.data;

                                // Update build status display
                                updateBuildStatus(status);

                                // Check if we need to reload
                                const currentVersion = localStorage.getItem('jelliculeVersion');
                                if (currentVersion && currentVersion !== status.version) {
                                    console.log('Components updated, refreshing...');
                                    location.reload();
                                }
                            }
                        } catch (err) {
                            console.error('Error processing WebSocket message:', err);
                        }
                    };

                    ws.onclose = () => {
                        clearTimeout(connectionTimeout);
                        reconnectAttempts++;

                        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                            console.log(`WebSocket disconnected after ${reconnectAttempts} attempts. Switching to offline mode.`);
                            isOfflineMode = true;
                            updateBuildStatus({}, true);
                        } else {
                            console.log(`WebSocket disconnected. Reconnecting in 3 seconds... (Attempt ${reconnectAttempts} of ${MAX_RECONNECT_ATTEMPTS})`);
                            setTimeout(connectWebSocket, 3000);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        clearTimeout(connectionTimeout);
                        ws.close();
                    };
                } catch (error) {
                    console.error('Error creating WebSocket connection:', error);
                    reconnectAttempts++;

                    if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                        console.log(`Failed to create WebSocket after ${reconnectAttempts} attempts. Switching to offline mode.`);
                        isOfflineMode = true;
                        updateBuildStatus({}, true);
                    } else {
                        setTimeout(connectWebSocket, 3000);
                    }
                }
            };

            // Initial connection
            document.addEventListener('DOMContentLoaded', () => {
                // Check if we're online
                if (!navigator.onLine) {
                    console.log('Browser reports offline status. Starting in offline mode.');
                    isOfflineMode = true;
                    updateBuildStatus({}, true);

                    // Try to load cached status
                    const cachedStatus = localStorage.getItem('jelliculeLastStatus');
                    if (cachedStatus) {
                        try {
                            updateBuildStatus(JSON.parse(cachedStatus));
                        } catch (e) {
                            console.error('Error parsing cached status:', e);
                        }
                    }
                    return;
                }

                // Load initial status
                fetch('build-status/status.json')
                    .then(response => response.json())
                    .then(status => {
                        updateBuildStatus(status);
                    })
                    .catch(err => {
                        console.log('Error loading initial status:', err);
                        // Try to load cached status
                        const cachedStatus = localStorage.getItem('jelliculeLastStatus');
                        if (cachedStatus) {
                            try {
                                updateBuildStatus(JSON.parse(cachedStatus));
                            } catch (e) {
                                console.error('Error parsing cached status:', e);
                                updateBuildStatus({}, true);
                            }
                        } else {
                            updateBuildStatus({}, true);
                        }
                    });

                // Connect to WebSocket only if we're online
                connectWebSocket();

                // Listen for online/offline events
                window.addEventListener('online', () => {
                    console.log('Browser reports online status. Attempting to reconnect.');
                    isOfflineMode = false;
                    reconnectAttempts = 0;
                    connectWebSocket();
                });

                window.addEventListener('offline', () => {
                    console.log('Browser reports offline status. Switching to offline mode.');
                    isOfflineMode = true;
                    updateBuildStatus({}, true);
                });
            });
        </script>
        <style>
            .build-status {
                position: fixed;
                bottom: 0;
                right: 0;
                padding: 5px 10px;
                font-family: monospace;
                font-size: 12px;
                color: white;
                background-color: #333;
                z-index: 9999;
            }
            .build-status.success {
                background-color: #4CAF50;
            }
            .build-status.failed {
                background-color: #F44336;
            }
            .build-status.offline {
                background-color: #FF9800;
            }
        </style>
        <!-- Import components directly -->
        <script type="module">
            // Import all components
            import './components/layout/ActivityViewport/activity-viewport.js';
            import './components/layout/ActivityBar/activity-bar.js';
            import './components/layout/Activity/activity.js';
            import './components/layout/ActivityResizeButton/activity-resize-button.js';
            import './components/layout/MainContent/main-content.js';
            import './components/layout/Content/content.js';
        </script>
    </head>
    <body>
        <div class="nav" style="position: sticky; top: 0; background-color: #fff; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 20px; z-index: 9999;">
            <a href="/" style="margin-right: 15px; text-decoration: none; color: #333;">Home</a>
            <a href="/download/" style="margin-right: 15px; text-decoration: none; color: #333;">Download</a>
            <a href="/documentation/" style="margin-right: 15px; text-decoration: none; color: #333;">Documentation</a>
        </div>

        <div id="build-status" class="build-status">Loading build status...</div>
        <Viewport>
            <ActivityBar
                orientation="top"
                activityList="['Home', 'Download', 'Documentation']"
                activityDefault="Home">
            </ActivityBar>
            <ActivityBar orientation="right">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A1</Activity>
                <Activity>A2</Activity>
                <Activity selected>A3</Activity>
                <Activity>A4</Activity>
            </ActivityBar>
            <ActivityBar orientation="bottom">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A3Z</Activity>
                <Activity>A3Y</Activity>
                <Activity>A3X</Activity>
                <Activity selected>A3W</Activity>
                <Activity>A3V</Activity>
            </ActivityBar>
            <ActivityBar orientation="left">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A13W99</Activity>
                <Activity>A13W98</Activity>
                <Activity>A13W97</Activity>
                <Activity>A13W96</Activity>
                <Activity selected active>A13W95</Activity>
            </ActivityBar>
            <MainContent context="e.g.: $ViewPort.context.current, A13W95"></MainContent>
        </Viewport>
        <script src="js/main.js" type="module"></script>

        <!-- Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }

            // Add to home screen prompt
            let deferredPrompt;
            const addBtn = document.createElement('button');
            addBtn.style.display = 'none';
            addBtn.textContent = 'Install Jellicule UI';
            addBtn.style.position = 'fixed';
            addBtn.style.bottom = '20px';
            addBtn.style.right = '20px';
            addBtn.style.padding = '10px 20px';
            addBtn.style.backgroundColor = '#2196F3';
            addBtn.style.color = 'white';
            addBtn.style.border = 'none';
            addBtn.style.borderRadius = '4px';
            addBtn.style.zIndex = '9999';
            addBtn.style.cursor = 'pointer';

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Update UI to notify the user they can add to home screen
                addBtn.style.display = 'block';

                addBtn.addEventListener('click', () => {
                    // Hide our user interface that shows our A2HS button
                    addBtn.style.display = 'none';
                    // Show the prompt
                    deferredPrompt.prompt();
                    // Wait for the user to respond to the prompt
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });

            document.body.appendChild(addBtn);
        </script>
    </body>
</html>