<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="theme-color" content="#f0f0f0">
        <meta name="description" content="Jellicule UI - A modern web component library">
        <title>j e l l i c u l e ! ! !</title>
        <link rel="stylesheet" href="styles/reset.css">
        <link rel="stylesheet" href="styles/jellicule.css">
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="icons/favicon.ico">
        <link rel="apple-touch-icon" href="icons/icon-192x192.png">
        <!-- WebSocket hot-reload and build status script -->
        <script>
            // Connect to WebSocket server for real-time updates
            const connectWebSocket = () => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname;
                const ws = new WebSocket(`${protocol}//${host}:8080`);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);

                        if (message.type === 'build-status') {
                            const status = message.data;

                            // Update build status display
                            const buildStatusElement = document.getElementById('build-status');
                            if (buildStatusElement) {
                                buildStatusElement.textContent = `Build: ${status.status} | Last build: ${status.time} | Version: ${status.version}`;
                                buildStatusElement.className = `build-status ${status.status}`;
                            }

                            // Check if we need to reload
                            const currentVersion = localStorage.getItem('jelliculeVersion');
                            if (currentVersion && currentVersion !== status.version) {
                                console.log('Components updated, refreshing...');
                                location.reload();
                            }
                            localStorage.setItem('jelliculeVersion', status.version);
                        }
                    } catch (err) {
                        console.error('Error processing WebSocket message:', err);
                    }
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected. Reconnecting in 3 seconds...');
                    setTimeout(connectWebSocket, 3000);
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    ws.close();
                };
            };

            // Initial connection
            document.addEventListener('DOMContentLoaded', () => {
                // Load initial status
                fetch('build-status/status.json')
                    .then(response => response.json())
                    .then(status => {
                        const buildStatusElement = document.getElementById('build-status');
                        if (buildStatusElement) {
                            buildStatusElement.textContent = `Build: ${status.status} | Last build: ${status.time} | Version: ${status.version}`;
                            buildStatusElement.className = `build-status ${status.status}`;
                        }
                        localStorage.setItem('jelliculeVersion', status.version);
                    })
                    .catch(err => console.log('Error loading initial status:', err));

                // Connect to WebSocket
                connectWebSocket();
            });
        </script>
        <style>
            .build-status {
                position: fixed;
                bottom: 0;
                right: 0;
                padding: 5px 10px;
                font-family: monospace;
                font-size: 12px;
                color: white;
                background-color: #333;
                z-index: 9999;
            }
            .build-status.success {
                background-color: #4CAF50;
            }
            .build-status.failed {
                background-color: #F44336;
            }
        </style>
        <!-- Import components directly -->
        <script type="module">
            // Import all components
            import './components/layout/ActivityViewport/activity-viewport.js';
            import './components/layout/ActivityBar/activity-bar.js';
            import './components/layout/Activity/activity.js';
            import './components/layout/ActivityResizeButton/activity-resize-button.js';
            import './components/layout/MainContent/main-content.js';
            import './components/layout/Content/content.js';
        </script>
    </head>
    <body>
        <div class="nav" style="position: sticky; top: 0; background-color: #fff; padding: 10px 0; border-bottom: 1px solid #eee; margin-bottom: 20px; z-index: 9999;">
            <a href="/" style="margin-right: 15px; text-decoration: none; color: #333;">Home</a>
            <a href="/download/" style="margin-right: 15px; text-decoration: none; color: #333;">Download</a>
            <a href="/documentation/" style="margin-right: 15px; text-decoration: none; color: #333;">Documentation</a>
        </div>

        <div id="build-status" class="build-status">Loading build status...</div>
        <Viewport>
            <ActivityBar
                orientation="top"
                activityList="['Home', 'Download', 'Documentation']"
                activityDefault="Home">
            </ActivityBar>
            <ActivityBar orientation="right">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A1</Activity>
                <Activity>A2</Activity>
                <Activity selected>A3</Activity>
                <Activity>A4</Activity>
            </ActivityBar>
            <ActivityBar orientation="bottom">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A3Z</Activity>
                <Activity>A3Y</Activity>
                <Activity>A3X</Activity>
                <Activity selected>A3W</Activity>
                <Activity>A3V</Activity>
            </ActivityBar>
            <ActivityBar orientation="left">
                <ActivityResizeButton></ActivityResizeButton>
                <Activity>A13W99</Activity>
                <Activity>A13W98</Activity>
                <Activity>A13W97</Activity>
                <Activity>A13W96</Activity>
                <Activity selected active>A13W95</Activity>
            </ActivityBar>
            <MainContent context="e.g.: $ViewPort.context.current, A13W95"></MainContent>
        </Viewport>
        <script src="js/main.js" type="module"></script>

        <!-- Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }
        </script>
    </body>
</html>