<!DOCTYPE html>
<html lang="en" data-theme="light">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="theme-color" content="#f5d76e">
        <meta name="description" content="j e l l i c u l e - A modern web component library">
        <title>j e l l i c u l e</title>
        <link rel="stylesheet" href="assets/styles/reset.css">
        <link rel="stylesheet" href="assets/styles/jellicule.css">
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="assets/icons/favicon.ico">
        <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">
        <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
        <style>
            :root {
                --font-retro: 'VT323', monospace;
                --font-pixel: 'Press Start 2P', cursive;
            }
            body {
                font-family: var(--font-retro);
            }
            h1, h2, h3, h4, h5, h6 {
                font-family: var(--font-pixel);
            }
        </style>
        <!-- WebSocket hot-reload and build status script -->
        <script>
            // Check if we're running in offline mode
            let isOfflineMode = false;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 3;

            // Function to update the build status display
            const updateBuildStatus = (status, isOffline = false) => {
                const buildStatusElement = document.getElementById('build-status');
                if (buildStatusElement) {
                    if (isOffline) {
                        buildStatusElement.textContent = 'Offline Mode - Local Version';
                        buildStatusElement.className = 'build-status offline';
                    } else {
                        buildStatusElement.textContent = `Build: ${status.status} | Last build: ${status.time} | Version: ${status.version}`;
                        buildStatusElement.className = `build-status ${status.status}`;
                    }
                }

                if (!isOffline) {
                    localStorage.setItem('jelliculeVersion', status.version);
                    localStorage.setItem('jelliculeLastStatus', JSON.stringify(status));
                }
            };

            // Connect to WebSocket server for real-time updates
            const connectWebSocket = () => {
                // If we're in offline mode and not explicitly trying to reconnect, don't attempt connection
                if (isOfflineMode && reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                    console.log('Running in offline mode, not attempting WebSocket connection');
                    return;
                }

                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.hostname;
                    const ws = new WebSocket(`${protocol}//${host}:8080`);

                    // Set a connection timeout
                    const connectionTimeout = setTimeout(() => {
                        console.log('WebSocket connection timeout');
                        ws.close();
                    }, 5000);

                    ws.onopen = () => {
                        console.log('WebSocket connected');
                        clearTimeout(connectionTimeout);
                        reconnectAttempts = 0;
                        isOfflineMode = false;
                    };

                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);

                            if (message.type === 'build-status') {
                                const status = message.data;

                                // Update build status display
                                updateBuildStatus(status);

                                // Check if we need to reload
                                const currentVersion = localStorage.getItem('jelliculeVersion');
                                if (currentVersion && currentVersion !== status.version) {
                                    console.log('Components updated, refreshing...');
                                    location.reload();
                                }
                            }
                        } catch (err) {
                            console.error('Error processing WebSocket message:', err);
                        }
                    };

                    ws.onclose = () => {
                        clearTimeout(connectionTimeout);
                        reconnectAttempts++;

                        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                            console.log(`WebSocket disconnected after ${reconnectAttempts} attempts. Switching to offline mode.`);
                            isOfflineMode = true;
                            updateBuildStatus({}, true);
                        } else {
                            console.log(`WebSocket disconnected. Reconnecting in 3 seconds... (Attempt ${reconnectAttempts} of ${MAX_RECONNECT_ATTEMPTS})`);
                            setTimeout(connectWebSocket, 3000);
                        }
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        clearTimeout(connectionTimeout);
                        ws.close();
                    };
                } catch (error) {
                    console.error('Error creating WebSocket connection:', error);
                    reconnectAttempts++;

                    if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                        console.log(`Failed to create WebSocket after ${reconnectAttempts} attempts. Switching to offline mode.`);
                        isOfflineMode = true;
                        updateBuildStatus({}, true);
                    } else {
                        setTimeout(connectWebSocket, 3000);
                    }
                }
            };

            // Initial connection
            document.addEventListener('DOMContentLoaded', () => {
                // Check if we're online
                if (!navigator.onLine) {
                    console.log('Browser reports offline status. Starting in offline mode.');
                    isOfflineMode = true;
                    updateBuildStatus({}, true);

                    // Try to load cached status
                    const cachedStatus = localStorage.getItem('jelliculeLastStatus');
                    if (cachedStatus) {
                        try {
                            updateBuildStatus(JSON.parse(cachedStatus));
                        } catch (e) {
                            console.error('Error parsing cached status:', e);
                        }
                    }
                    return;
                }

                // Load initial status
                fetch('build-status/status.json')
                    .then(response => response.json())
                    .then(status => {
                        updateBuildStatus(status);
                    })
                    .catch(err => {
                        console.log('Error loading initial status:', err);
                        // Try to load cached status
                        const cachedStatus = localStorage.getItem('jelliculeLastStatus');
                        if (cachedStatus) {
                            try {
                                updateBuildStatus(JSON.parse(cachedStatus));
                            } catch (e) {
                                console.error('Error parsing cached status:', e);
                                updateBuildStatus({}, true);
                            }
                        } else {
                            updateBuildStatus({}, true);
                        }
                    });

                // Connect to WebSocket only if we're online
                connectWebSocket();

                // Listen for online/offline events
                window.addEventListener('online', () => {
                    console.log('Browser reports online status. Attempting to reconnect.');
                    isOfflineMode = false;
                    reconnectAttempts = 0;
                    connectWebSocket();
                });

                window.addEventListener('offline', () => {
                    console.log('Browser reports offline status. Switching to offline mode.');
                    isOfflineMode = true;
                    updateBuildStatus({}, true);
                });
            });
        </script>
        <style>
            .build-status {
                position: fixed;
                bottom: 0;
                right: 0;
                padding: 5px 10px;
                font-family: monospace;
                font-size: 12px;
                color: white;
                background-color: #333;
                z-index: 9999;
            }
            .build-status.success {
                background-color: #4CAF50;
            }
            .build-status.failed {
                background-color: #F44336;
            }
            .build-status.offline {
                background-color: #FF9800;
            }
        </style>
        <!-- Import components -->
        <script type="module">
            // Import component registry
            import '../files/components/component-registry.js';
        </script>
    </head>
    <body>
        <div id="build-status" class="build-status">Loading build status...</div>

        <jc-activity-viewport>
            <!-- Top Navigation Bar -->
            <jc-activity-bar orientation="top">
                <jc-activity-resize-button></jc-activity-resize-button>
                <jc-activity icon="üè†" label="Home" selected></jc-activity>
                <jc-activity icon="‚¨áÔ∏è" label="Download"></jc-activity>
                <jc-activity icon="üìö" label="Documentation"></jc-activity>
                <jc-activity icon="üîå" label="API"></jc-activity>
                <jc-activity icon="üß©" label="Examples"></jc-activity>
                <jc-activity icon="‚ÑπÔ∏è" label="About"></jc-activity>
            </jc-activity-bar>

            <!-- Right Tools Bar -->
            <jc-activity-bar orientation="right">
                <jc-activity-resize-button></jc-activity-resize-button>
                <jc-activity icon="üé®" label="Theme"></jc-activity>
                <jc-activity icon="‚öôÔ∏è" label="Settings"></jc-activity>
                <jc-activity icon="üîç" label="Search" selected></jc-activity>
                <jc-activity icon="‚ùì" label="Help"></jc-activity>
            </jc-activity-bar>

            <!-- Bottom Status Bar -->
            <jc-activity-bar orientation="bottom">
                <jc-activity-resize-button></jc-activity-resize-button>
                <jc-activity icon="‚úÖ" label="Status"></jc-activity>
                <jc-activity icon="üîî" label="Notifications"></jc-activity>
                <jc-activity icon="üìä" label="Statistics" selected></jc-activity>
                <jc-activity icon="üìù" label="Logs"></jc-activity>
            </jc-activity-bar>

            <!-- Left Navigation Bar -->
            <jc-activity-bar orientation="left">
                <jc-activity-resize-button></jc-activity-resize-button>
                <jc-activity icon="üìã" label="Components" selected></jc-activity>
                <jc-activity icon="üß∞" label="Tools"></jc-activity>
                <jc-activity icon="üîß" label="Utilities"></jc-activity>
                <jc-activity icon="üì¶" label="Resources"></jc-activity>
            </jc-activity-bar>

            <!-- Main Content Area -->
            <jc-main-content>
                <jc-content width="default">
                    <h1 style="margin-bottom: 20px; font-size: 2rem; text-align: center;">j e l l i c u l e</h1>
                    <h2 style="margin-bottom: 15px; font-size: 1.2rem; text-align: center;">A Retro-Themed Web Component Library</h2>

                    <div style="margin: 30px 0; padding: 20px; border: 1px solid var(--jc-border); border-radius: 4px;">
                        <h3 style="margin-bottom: 15px;">Component Showcase</h3>
                        <p style="margin-bottom: 15px;">This page demonstrates the core components of the j e l l i c u l e library. Use the activity bars on each side to navigate through different sections.</p>

                        <ul style="list-style: none; padding: 0; margin: 20px 0;">
                            <li style="margin-bottom: 10px;">üè† <strong>Home</strong> - Overview and component showcase</li>
                            <li style="margin-bottom: 10px;">‚¨áÔ∏è <strong>Download</strong> - Download options and instructions</li>
                            <li style="margin-bottom: 10px;">üìö <strong>Documentation</strong> - Component documentation</li>
                            <li style="margin-bottom: 10px;">üîå <strong>API</strong> - API documentation</li>
                            <li style="margin-bottom: 10px;">üß© <strong>Examples</strong> - Usage examples</li>
                            <li style="margin-bottom: 10px;">‚ÑπÔ∏è <strong>About</strong> - Project information</li>
                        </ul>

                        <p>Click on the hamburger menu in the top-left corner to expand the activity bars.</p>
                    </div>

                    <div style="display: flex; justify-content: center; margin-top: 30px;">
                        <button id="theme-toggle" style="padding: 10px 20px; background: var(--jc-chrome); border: 1px solid var(--jc-border); border-radius: 4px; cursor: pointer; font-family: var(--font-retro); font-size: 1rem;">Toggle Theme</button>
                    </div>
                </jc-content>
            </jc-main-content>
        </jc-activity-viewport>

        <script src="assets/js/main.js" type="module"></script>

        <!-- Theme Toggle Script -->
        <script>
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('jellicule-theme', newTheme);
            });

            // Check for saved theme preference
            document.addEventListener('DOMContentLoaded', () => {
                const savedTheme = localStorage.getItem('jellicule-theme');
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                }
            });
        </script>

        <!-- Service Worker Registration -->
        <script>
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./service-worker.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed: ', error);
                        });
                });
            }

            // Add to home screen prompt
            let deferredPrompt;
            const addBtn = document.createElement('button');
            addBtn.style.display = 'none';
            addBtn.textContent = 'Install Jellicule UI';
            addBtn.style.position = 'fixed';
            addBtn.style.bottom = '20px';
            addBtn.style.right = '20px';
            addBtn.style.padding = '10px 20px';
            addBtn.style.backgroundColor = '#2196F3';
            addBtn.style.color = 'white';
            addBtn.style.border = 'none';
            addBtn.style.borderRadius = '4px';
            addBtn.style.zIndex = '9999';
            addBtn.style.cursor = 'pointer';

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Update UI to notify the user they can add to home screen
                addBtn.style.display = 'block';

                addBtn.addEventListener('click', () => {
                    // Hide our user interface that shows our A2HS button
                    addBtn.style.display = 'none';
                    // Show the prompt
                    deferredPrompt.prompt();
                    // Wait for the user to respond to the prompt
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });

            document.body.appendChild(addBtn);
        </script>
    </body>
</html>